name: Build NetHunter Kernel for A30s

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Clone Kernel Source
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential git clang lld bc bison flex libssl-dev \
          libncurses5-dev libelf-dev gcc-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu device-tree-compiler

    - name: Set up Clang Toolchain
      run: |
        git clone --depth=1 https://github.com/ClangBuiltLinux/llvm-project clang
        echo "$PWD/clang/bin" >> $GITHUB_PATH

    - name: Fix script permissions
      run: |
        chmod +x scripts/clang-android.sh || true

    - name: Configure Kernel
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export ANDROID_MAJOR_VERSION=11
        export KBUILD_BUILD_USER=NetHunter
        export KBUILD_BUILD_HOST=GitHub

        make O=out ARCH=arm64 a30s_defconfig

    - name: Disable VDSO for Clang compatibility
      run: |
        sed -i '/CONFIG_COMPAT_VDSO/d' out/.config
        echo "# CONFIG_COMPAT_VDSO is not set" >> out/.config
        make O=out ARCH=arm64 olddefconfig

    - name: Patch DTC Lexer to fix yylloc error
      run: |
        cat << 'EOF' > fix_dtc.patch
          diff --git a/scripts/dtc/dtc-lexer.l b/scripts/dtc/dtc-lexer.l
          index c600603044f3..cf7707be43aa 100644
          --- a/scripts/dtc/dtc-lexer.l
          +++ b/scripts/dtc/dtc-lexer.l
          @@ -38,7 +38,6 @@ LINECOMMENT   "//".*\n
 #include "srcpos.h"
 #include "dtc-parser.tab.h"

          -YYLTYPE yylloc;
            extern bool treesource_error;

            /* CAUTION: this will stop working if we ever use yyless() or yyunput() */
           diff --git a/scripts/dtc/dtc-lexer.lex.c_shipped b/scripts/dtc/dtc-lexer.lex.c_shipped
           index 2c862bc86ad0..e3663ce1af5d 100644
           --- a/scripts/dtc/dtc-lexer.lex.c_shipped
           +++ b/scripts/dtc/dtc-lexer.lex.c_shipped
           @@ -631,7 +631,6 @@ char *yytext;
 #include "srcpos.h"
 #include "dtc-parser.tab.h"

          -YYLTYPE yylloc;
          extern bool treesource_error;

          /* CAUTION: this will stop working if we ever use yyless() or yyunput() */
          EOF

           git apply fix_dtc.patch

    - name: Build Kernel
      run: |
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export ANDROID_MAJOR_VERSION=11
        export KBUILD_BUILD_USER=NetHunter
        export KBUILD_BUILD_HOST=GitHub

        export HOSTCFLAGS="-Wno-error"

        make -j$(nproc) O=out ARCH=arm64 CC=clang CROSS_COMPILE=aarch64-linux-gnu-

    - name: Concatenate Image.gz and DTB
      run: |
        cat out/arch/arm64/boot/Image.gz out/arch/arm64/boot/dts/exynos/*.dtb > out/arch/arm64/boot/Image.gz-dtb

    - name: Prepare Flashable ZIP (AnyKernel3)
      run: |
        git clone https://github.com/osm0sis/AnyKernel3 anykernel
        cp out/arch/arm64/boot/Image.gz-dtb anykernel/zImage
        cd anykernel
        zip -r9 Nethunter-A30s-Kernel.zip *

    - name: Upload to Releases
      uses: ncipollo/release-action@v1
      with:
        tag: a30s-nethunter
        name: NetHunter Kernel for A30s
        artifacts: "anykernel/Nethunter-A30s-Kernel.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
